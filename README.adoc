:toc: macro
toc::[] 


= COMPENDIUM

Compendium is a processor for generating, unifying and converting different sources like AsciiDoc files, Markdown files, Confluence and html websites in different formats.
We can select all the content or only parts of it and generate an AsciiDoc, Markdown, HTML or PDF.

== Tags covered in the IR (Itermediate Representation)

h1, h2, h3, h4, h5, p, a, img, table, ul, ol, code, br.
Inside a list: ul, ol, p, div, a, code.
Inside a table: p, img, table, span, ul, ol, a, code, div.

== Technologies
This project uses different technologies. Here is a list of all of them:

* link:https://code.visualstudio.com/[Visual Studio Code] +
It's a great programme, because it can use in every SO and it's free. We developed using 1.19.2 version

* link:https://nodejs.org/en/[NodeJS] +
Server-side development using the basics of the Express framework. It is a JavaScript runtime built on Chrome's V8 JavaScript engine. Node.js uses an event-driven, non-blocking I/O model that makes it lightweight and efficient. 

* link:https://github.com/asciidoctor/asciidoctor.js[Asciidoctor.js] +
Server-side development using the 1.5.6 version. Asciidoctor.js uses Opal to transpile Asciidoctor from Ruby to Javascript, we can run on any Javascript platform.

* link:https://www.npmjs.com/[NPM] +
A Command line client using 5.6.0 version. NPM is the package manager for Javascript, packages are open-source. It consists of three distinct components, one of them is the Commando Line Interface (CLI). Because of, CLI runs from a terminal, we interact with it.

* link:http://yargs.js.org/[Yargs] +
Command line tool using 5.0 version. Yargs is a node.js library, and help us build an interactive command line tool by parsing arguments and implementing new enhanced interface.

=== Other VSCode extensions and node modules

* link:https://marketplace.visualstudio.com/items?itemName=joaompinto.asciidoctor-vscode[AsciiDoc VSCode extension] +
An extension that provides live preview, syntax highlighting and symbols for the AsciiDoc format. The preview uses Asciidoctor.js.
Toggle Preview - ctrl+shift+v (Mac: cmd+shift+v)

* link:https://www.npmjs.com/[NPM] +
Node-Modules:
** request, make http node request easier.
** extra-fs, a fyle-system module that works with promises and async/await.
** util, an easy way to convert callback functions in promises.
** chai and mocha, for unit testing.
** cheerio, parses markup and provides an API for traversing/manipulating the resulting data structure. We have use it in the url-html input as an easy way to find link tags.
** prompt, command-line prompt for node.js
** shelljs, is a portable implementation of Unix shell commands on top of the Node.js API. 
** html-parse, an HTML/XML parser that doesn't require valid HTML/XML. It's also meant to act as a sanitizer.
** htmlto, a Node module to convert HTML to PDF.
** turndown, a Node module to convert HTML to Markdown.
** showdown, a Node module to convert Markdown to HTML.


== Operating mode

For the definition of the programming interfaces have been developed for both the inputs and the outputs. +
Thus, when adding new features is much easier, since we only have to implement the necessary classes and the interface. +
On the other hand, tests have been carried out, which verify that the operation of the code is correct and in case of failure we quickly know where our problem lies.
At final, we can see a scheme to know what is the operation depending on the input or output parameters.


==== Asciidoc input
image::./images/AsciidocInput.PNG[ASCIIDOC INPUT]

==== Confluence input
image::./images/ConfluenceInput.PNG[CONFLUENCE INPUT]

==== Asciidoc output
image::./images/AsciidocOutput.PNG[ASCIIDOC OUTPUT]

==== HTML output
image::./images/HTMLOutput.PNG[HTML OUTPUT]


== Compendium processing

Compendium can be installed using `npm install` command in the terminal. +
Open a terminal and type : 

    $ npm install
    $ npm install -g ts-node

== Usage 

If you could install successfully Compendium, the command line interface (CLI) will be available in your PATH. To verify this, you can run the following in your terminal: 

    $ node compendium.js --version 

You should see the information about the Compendium version printed in the terminal. +
`0.0.9` 

=== Command line interface (CLI)

The `compendium` command allows you to invoke Compendium from the command line. For a correct usage you need to introduce five arguments.

[source]
node compendium.js [-f] <config file> [--asciidoc|--html|--pdf | --markdown] <output file>

Options:
  --version   Show version number
  -f          Input type: JSON Config file (This is by default)
  --asciidoc  Output type: asciidoc file
  --html      Output type: Html file
  --pdf       Output type: PDF file
  --markdown  Output type: MD file
  -h, --help  Show help

Depending of the input type, you can use Compendium in different ways, since within this file you can do as much as asciidoc files, html urls and confluence pages. 


==== JSON Config file

To obtain a file with different sources the best way is using a JSON Config file. To write it, we need to know the following. +
The file has two differentiated parts, the first part which contains the sources, and the second part, which contains the documents. +
First, we need to define the different sources, we can define as many sources as necessary. In this part, for each source we have three different arguments:

* reference: It's a reference, it refers the content in the file.
* source_type: It's the type or document format (i.e asciidoc).
* source: It's the URL or PATH where the information is located.

On the other hand, we need to define the documents, as to the sources, we can have all the documents that are necessary. For each node we have three arguments also:

* reference: It's a reference, it refers sources reference.
* document: It's the file name or name/id project (i.e examples.adoc).
* sections: It's the section that you want to extract. If you want to extract all the content in the document you should leave this argument blank, but if you want to extract different sections, you should write in an array. (i.e sections: [h1, h3])

To read from confluence internal network we need to add this arguments to the source part:
* context: capgemini
* space: space key of the project, all the urls of the project have this letters.
   example: (https://adcenter.pl.s2-eu.capgemini.com/confluence/display/HD/2.+Objectives ) 
            space=> HD



IMPORTANT: You can't write the same reference, each reference should be unique. And if you want to extract Confluence information you need to introduce your credentials to get the information.


===== Types of Inputs available

* Asciidoc documents: 
** source_type: asciidoc  (reads directly from local .adoc documents)
** source: Local Path.

* Markdown documents: 
** source_type: markdown  (reads directly from local .md documents)
** source: Local Path.

* Confluence pages:
** source_type: confluence 
** source: base url of confluence account
** context: capgemini (internal network) or external(private confluence account)
** space: JQ (project space key)

* Html pages directly from a website:
** source_type: url-html  
** source: url 
* In the url-html type the document part have an optional attribute: (document is an index, where we have to extract all the links from. And include them in the output file, so that we download all the pages from a site). The document has to be unique and consider the following:
** document: index url
** is_index: true or false (to indicate if we have to read an index)

===== Types of Outputs available

* Pdf 
* Html
* Asciidoc
* Markdown


==== Config File examples (mocks within the project folder test-data)

===== Example of Config File with diferent sources

Config file example with confluence and local asciidoc and markdown files:
test-data/input/configMix.json 
Command:
$ ts-node src/compendium.ts -f test-data/input/configMix.json --html out/out

===== Local asciidoc Input - Diferent Output types

This are the command and you can find the config.json enclosed:
[source]
$ ts-node src/compendium.ts -f test-data/input/configLocal.json --html out/out
$ ts-node src/compendium.ts -f test-data/input/configLocal.json --pdf out/out
$ ts-node src/compendium.ts -f test-data/input/configLocal.json --asciidoc out/out

===== Url html type Input - Html Output

Config file with several urls from handbook, config.json file example, the command:
[source]
$ ts-node src/compendium.ts -f test-data/confiles/html-url/config.json --html out/out

===== Url html type with is_index true - Html Output

Config file with a is_index true and a unique url document pointing at the handbook source.Have a look at the config.json file example, the command:
[source]
$ ts-node src/compendium.ts -f test-data/confiles/html-url/configAllIndex.json --html out/out

===== Internal Confluence Input - Asciidoc Output

Config file with an example of internal capgemini confluence source and several documents, the command: (enter active credentials of the ad-center confluence )
[source]
$ ts-node src/compendium.ts -f test-data/input/confluence/configCapgemini.json --asciidoc out/out

===== Markdown type Input/Output
Config file with an example of local markdown documents, extension .md.
Command:
[source]
$ ts-node src/compendium.ts -f test-data/input/markdown/configLocal.json --html out/out


== UML

image::./images/compendiumDiagram/compendiumDiagram.png[USAGE]

